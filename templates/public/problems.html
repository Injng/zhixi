{% extends "public/layout.html" %}

{% block problems_tab_class %}text-ink-0 border-b border-ink-0{% endblock %}

{% block content %}
<div class="mb-8">
  <div class="flex items-baseline gap-3">
    <h1 class="text-xl font-bold tracking-tight text-ink-0 uppercase">{% if lang == "zh" %}题库{% else %}Problems{% endif
      %}</h1>
    <span class="text-sm text-ink-3">{{ course.code }}</span>
  </div>
</div>

{% if all_categories.is_empty() && problems.is_empty() %}
<div class="py-16 text-center">
  <p class="text-sm text-ink-3 uppercase tracking-widest">{% if lang == "zh" %}暂无练习题{% else %}no problems{% endif %}</p>
</div>
{% else %}

{% if !all_categories.is_empty() %}
<div class="mb-6 flex flex-wrap gap-2" id="category-filters">
  <button onclick="filterAll()"
    class="filter-btn px-3 py-1.5 text-xs font-bold uppercase tracking-wider border transition-colors bg-ink-0 text-white border-ink-0"
    data-category="all">
    {% if lang == "zh" %}all{% else %}all{% endif %}
  </button>
  {% for cat in all_categories %}
  <button onclick="toggleCategory(this)"
    class="filter-btn px-3 py-1.5 text-xs font-bold uppercase tracking-wider border border-surface-2 text-ink-2 hover:border-ink-3 hover:text-ink-0 transition-colors"
    data-category="{{ cat }}">
    {{ cat }}
  </button>
  {% endfor %}
</div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="problem-grid">
  {% for problem in problems %}
  <div class="problem-card border border-surface-2 overflow-hidden hover:border-ink-3 transition-colors group"
    data-categories="{{ problem.category_names.as_deref().unwrap_or("") }}">

    <div class="px-4 py-2.5 border-b border-surface-2 flex items-center justify-between bg-surface-0">
      <div class="flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full {% if problem.source_kind == " Lecture" %}bg-accent{% else if
          problem.source_kind=="Discussion" %}bg-emerald-500{% else if problem.source_kind=="Lab" %}bg-violet-500{% else
          if problem.source_kind=="Homework" %}bg-amber-500{% else if problem.source_kind=="Quiz" %}bg-rose-400{% else
          if problem.source_kind=="Midterm" %}bg-red-600{% else %}bg-ink-3{% endif %}"></span>
        <span class="text-xs font-bold uppercase tracking-wider text-ink-2">
          {{ problem.source_kind }}
        </span>
        {% if !problem.source_title.is_empty() %}
        <span class="text-xs text-ink-3">{{ problem.source_title }}</span>
        {% endif %}
      </div>
      {% if let Some(cats) = problem.category_names %}
      <div class="flex gap-1.5 flex-wrap justify-end">
        {% for cat in cats.split(',') %}
        <span class="text-[11px] px-2 py-0.5 border border-surface-2 text-ink-2 font-medium tracking-wide">{{ cat
          }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    {% if let Some(url) = problem.image_url %}
    <div class="p-3 bg-surface-0">
      <img src="{{ url }}" alt="Problem" class="max-h-80 object-contain w-full">
    </div>
    {% endif %}

    {% if problem.notes.is_some() || problem.solution_link.is_some() %}
    <div class="px-4 py-3 border-t border-surface-2 flex items-start justify-between gap-3">
      <div class="flex-1 min-w-0">
        {% if let Some(notes) = problem.notes %}
        <p class="text-sm text-ink-1 whitespace-pre-wrap prose-body leading-relaxed">{{ notes }}</p>
        {% endif %}
      </div>
      {% if let Some(link) = problem.solution_link %}
      {% if !link.is_empty() %}
      <a href="{{ link }}" target="_blank"
        class="shrink-0 text-xs font-bold uppercase tracking-wider text-accent hover:underline underline-offset-2">
        {% if lang == "zh" %}解答{% else %}soln{% endif %}
      </a>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<script>
  let activeCategories = new Set();

  function filterAll() {
    activeCategories.clear();
    updateFilters();
  }

  function toggleCategory(btn) {
    const cat = btn.dataset.category;
    if (activeCategories.has(cat)) {
      activeCategories.delete(cat);
    } else {
      activeCategories.add(cat);
    }
    updateFilters();
  }

  function updateFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      const cat = btn.dataset.category;
      const isActive = cat === 'all'
        ? activeCategories.size === 0
        : activeCategories.has(cat);
      if (isActive) {
        btn.classList.add('bg-ink-0', 'text-white', 'border-ink-0');
        btn.classList.remove('text-ink-2', 'border-surface-2');
      } else {
        btn.classList.remove('bg-ink-0', 'text-white', 'border-ink-0');
        btn.classList.add('text-ink-2', 'border-surface-2');
      }
    });

    const count = { shown: 0, total: 0 };
    document.querySelectorAll('.problem-card').forEach(card => {
      count.total++;
      if (activeCategories.size === 0) {
        card.style.display = '';
        count.shown++;
        return;
      }
      const cardCats = (card.dataset.categories || '').split(',').map(s => s.trim());
      const match = [...activeCategories].some(c => cardCats.includes(c));
      card.style.display = match ? '' : 'none';
      if (match) count.shown++;
    });
  }
</script>

{% endif %}
{% endblock %}
